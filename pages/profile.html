<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой профиль - HelpProjects</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="logo">
                <i class="fas fa-hands-helping"></i>
                <span>HelpProjects</span>
            </a>
            
            <div class="nav-links">
                <a href="../index.html"><i class="fas fa-home"></i> Главная</a>
                <a href="projects.html"><i class="fas fa-project-diagram"></i> Проекты</a>
                <a href="create.html"><i class="fas fa-plus-circle"></i> Создать</a>
                <div id="user-menu">
                    <a href="profile.html" class="active"><i class="fas fa-user"></i> Профиль</a>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Выйти</a>
                </div>
            </div>
            
            <button class="menu-toggle" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Заголовок профиля -->
    <header class="profile-header">
        <div class="container">
            <div class="profile-info">
                <div class="avatar">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="profile-details">
                    <h1 id="profile-name">Загрузка...</h1>
                    <p id="profile-email"></p>
                    <p id="profile-school"></p>
                    <div class="profile-stats">
                        <div class="stat">
                            <span id="projects-count">0</span>
                            <small>Проектов</small>
                        </div>
                        <div class="stat">
                            <span id="total-amount">0 ₽</span>
                            <small>Собрано</small>
                        </div>
                        <div class="stat">
                            <span id="supporters-count">0</span>
                            <small>Поддержали</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Мои проекты -->
        <section class="my-projects">
            <div class="section-header">
                <h2><i class="fas fa-rocket"></i> Мои проекты</h2>
                <a href="create.html" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Новый проект
                </a>
            </div>
            
            <div class="projects-grid" id="user-projects">
                <div class="loading">Загрузка проектов...</div>
            </div>
            
            <div id="no-projects" style="display: none; text-align: center; padding: 40px;">
                <i class="fas fa-folder-open" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                <h3>У вас пока нет проектов</h3>
                <p>Создайте свой первый проект и начните собирать средства!</p>
                <a href="create.html" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Создать проект
                </a>
            </div>
        </section>

        <!-- Настройки профиля -->
        <section class="profile-settings">
            <h2><i class="fas fa-cog"></i> Настройки профиля</h2>
            
            <div class="settings-grid">
                <div class="setting-card">
                    <h3><i class="fas fa-user-edit"></i> Личные данные</h3>
                    <form id="profile-form" onsubmit="return updateProfile(event)">
                        <div class="form-group">
                            <label>ФИО</label>
                            <input type="text" id="edit-name" placeholder="Ваше ФИО">
                        </div>
                        <div class="form-group">
                            <label>Учебное заведение</label>
                            <input type="text" id="edit-school" placeholder="Школа/Колледж/ВУЗ">
                        </div>
                        <div class="form-group">
                            <label>Класс/Группа</label>
                            <input type="text" id="edit-class" placeholder="11А или Группа П-21">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Сохранить
                        </button>
                    </form>
                    <div id="profile-message" class="message"></div>
                </div>
                
                <div class="setting-card">
                    <h3><i class="fas fa-lock"></i> Безопасность</h3>
                    <form id="password-form" onsubmit="return changePassword(event)">
                        <div class="form-group">
                            <label>Текущий пароль</label>
                            <input type="password" id="current-password" placeholder="Текущий пароль">
                        </div>
                        <div class="form-group">
                            <label>Новый пароль</label>
                            <input type="password" id="new-password" placeholder="Не менее 6 символов">
                        </div>
                        <div class="form-group">
                            <label>Повторите новый пароль</label>
                            <input type="password" id="confirm-password" placeholder="Повторите пароль">
                        </div>
                        <button type="submit" class="btn btn-secondary">
                            <i class="fas fa-key"></i> Изменить пароль
                        </button>
                    </form>
                    <div id="password-message" class="message"></div>
                </div>
                
                <div class="setting-card">
                    <h3><i class="fas fa-bell"></i> Уведомления</h3>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="notify-email" checked>
                            <span>Email уведомления</span>
                        </label>
                        <label>
                            <input type="checkbox" id="notify-project-updates" checked>
                            <span>Обновления проектов</span>
                        </label>
                        <label>
                            <input type="checkbox" id="notify-support" checked>
                            <span>Новые поддержки</span>
                        </label>
                    </div>
                    <button onclick="saveNotifications()" class="btn btn-outline">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Футер -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3><i class="fas fa-hands-helping"></i> HelpProjects</h3>
                    <p>Краудфандинговая платформа для реализации учебных проектов учащихся.</p>
                </div>
                <div class="footer-section">
                    <h3>Навигация</h3>
                    <a href="../index.html">Главная</a>
                    <a href="projects.html">Проекты</a>
                    <a href="create.html">Создать проект</a>
                    <a href="profile.html">Профиль</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 HelpProjects. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <!-- Подключаем скрипты -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/database.js"></script>
    <script>
        // Проверка авторизации
        document.addEventListener('DOMContentLoaded', function() {
            const user = window.auth?.getUser();
            
            if (!user) {
                window.location.href = '../index.html';
                return;
            }
            
            // Загружаем профиль
            loadProfile();
            loadUserProjects();
            
            // Обновляем UI
            if (window.auth) {
                window.auth.updateUI();
            }
        });
        
        // Загрузка профиля
        function loadProfile() {
            const user = window.auth.getUser();
            
            if (user) {
                document.getElementById('profile-name').textContent = user.fullName || user.full_name || user.email;
                document.getElementById('profile-email').textContent = user.email;
                document.getElementById('profile-school').textContent = 
                    (user.school ? user.school + ' • ' : '') + (user.class || user.className || '');
                
                // Заполняем форму редактирования
                document.getElementById('edit-name').value = user.fullName || user.full_name || '';
                document.getElementById('edit-school').value = user.school || '';
                document.getElementById('edit-class').value = user.class || user.className || '';
            }
        }
        
        // Загрузка проектов пользователя
        async function loadUserProjects() {
            const projectsContainer = document.getElementById('user-projects');
            const noProjects = document.getElementById('no-projects');
            
            if (!projectsContainer) return;
            
            try {
                const projects = window.projectDB.getAllProjects();
                const user = window.auth.getUser();
                
                // Фильтруем проекты пользователя
                const userProjects = projects.filter(p => 
                    p.author_email === user.email || p.author_id === user.id
                );
                
                if (userProjects.length === 0) {
                    projectsContainer.style.display = 'none';
                    noProjects.style.display = 'block';
                    return;
                }
                
                // Обновляем статистику
                const totalAmount = userProjects.reduce((sum, p) => sum + (parseFloat(p.current_amount) || 0), 0);
                document.getElementById('projects-count').textContent = userProjects.length;
                document.getElementById('total-amount').textContent = totalAmount.toFixed(0) + ' ₽';
                
                // Отображаем проекты
                projectsContainer.innerHTML = userProjects.map(project => `
                    <div class="project-card">
                        <div class="project-image">
                            <img src="https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="${project.title}">
                        </div>
                        <div class="project-content">
                            <h3 class="project-title">${project.title}</h3>
                            <p class="project-description">${project.description.substring(0, 80)}...</p>
                            <div class="project-goal">
                                <div class="progress-bar">
                                    <div class="progress" style="width: ${Math.min((project.current_amount / project.goal * 100), 100)}%"></div>
                                </div>
                                <div class="project-stats">
                                    <span>Собрано: ${project.current_amount} ₽</span>
                                    <span>Цель: ${project.goal} ₽</span>
                                </div>
                            </div>
                            <div class="project-actions">
                                <button onclick="editProject('${project.id}')" class="btn btn-sm btn-outline">
                                    <i class="fas fa-edit"></i> Редактировать
                                </button>
                                <button onclick="deleteProject('${project.id}')" class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i> Удалить
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Ошибка загрузки проектов:', error);
                projectsContainer.innerHTML = '<div class="error">Ошибка загрузки проектов</div>';
            }
        }
        
        // Обновление профиля
        async function updateProfile(event) {
            event.preventDefault();
            
            const userData = {
                fullName: document.getElementById('edit-name').value,
                school: document.getElementById('edit-school').value,
                className: document.getElementById('edit-class').value
            };
            
            const messageEl = document.getElementById('profile-message');
            
            try {
                // Обновляем данные в localStorage
                const user = window.auth.getUser();
                const updatedUser = { ...user, ...userData };
                
                window.auth.currentUser = updatedUser;
                localStorage.setItem('helprojects_user', JSON.stringify(updatedUser));
                
                // Обновляем в списке пользователей
                if (window.useLocalStorage) {
                    const users = JSON.parse(localStorage.getItem('helprojects_users') || '[]');
                    const index = users.findIndex(u => u.email === user.email);
                    if (index !== -1) {
                        users[index] = { ...users[index], ...userData };
                        localStorage.setItem('helprojects_users', JSON.stringify(users));
                    }
                }
                
                messageEl.innerHTML = `<div class="message success">
                    <i class="fas fa-check-circle"></i> Профиль обновлен!
                </div>`;
                
                // Обновляем отображение
                loadProfile();
                
            } catch (error) {
                messageEl.innerHTML = `<div class="message error">
                    <i class="fas fa-exclamation-circle"></i> Ошибка: ${error.message}
                </div>`;
            }
        }
        
        // Смена пароля
        function changePassword(event) {
            event.preventDefault();
            
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            
            const messageEl = document.getElementById('password-message');
            
            if (newPass.length < 6) {
                messageEl.innerHTML = `<div class="message error">
                    <i class="fas fa-exclamation-circle"></i> Пароль должен быть не менее 6 символов
                </div>`;
                return;
            }
            
            if (newPass !== confirmPass) {
                messageEl.innerHTML = `<div class="message error">
                    <i class="fas fa-exclamation-circle"></i> Пароли не совпадают
                </div>`;
                return;
            }
            
            messageEl.innerHTML = `<div class="message success">
                <i class="fas fa-check-circle"></i> Пароль успешно изменен!
            </div>`;
            
            // В реальном проекте здесь был бы запрос к серверу
            event.target.reset();
        }
        
        // Сохранение уведомлений
        function saveNotifications() {
            const settings = {
                email: document.getElementById('notify-email').checked,
                projectUpdates: document.getElementById('notify-project-updates').checked,
                support: document.getElementById('notify-support').checked
            };
            
            localStorage.setItem('helprojects_notifications', JSON.stringify(settings));
            
            alert('Настройки уведомлений сохранены!');
        }
        
        // Управление проектами
        function editProject(projectId) {
            // В реальном проекте здесь была бы страница редактирования
            alert('Редактирование проекта ' + projectId);
        }
        
        async function deleteProject(projectId) {
            if (!confirm('Вы уверены, что хотите удалить этот проект?')) {
                return;
            }
            
            const result = await window.projectDB.deleteProject(projectId);
            
            if (result.success) {
                alert('Проект удален');
                loadUserProjects();
            } else {
                alert('Ошибка: ' + result.message);
            }
        }
        
        // Выход
        function logout() {
            window.auth.logout();
            window.location.href = '../index.html';
        }
        
        // Мобильное меню
        function toggleMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('active');
        }
        
        window.toggleMenu = toggleMenu;
        window.logout = logout;
    </script>
    
    <style>
        /* Дополнительные стили для профиля */
        .profile-header {
            background: linear-gradient(135deg, #4a6bdf 0%, #6a8eff 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 40px;
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .avatar {
            width: 120px;
            height: 120px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
        
        .profile-details h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .profile-details p {
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .profile-stats {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat span {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        
        .setting-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .setting-card h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .project-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        @media (max-width: 768px) {
            .profile-info {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-stats {
                justify-content: center;
            }
            
            .section-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
        }
    </style>
</body>
</html>
